{% extends "base.html" %}
{% block title %}{{ data.event.title }}{% endblock %}
{% block content %}
	<div class="card p-4 mx-auto" style="max-width: 600px;">
		<div class="card-body text-center">
			<h1 class="event-title">{{ data.event.title }}</h1>
			{% if data.event.game_setting %}
				<p class="event-subtitle">Setting: {{ data.event.game_setting }}</p>
			{% endif %}

			<p class="mt-3">{{ data.event.description }}</p>

			<ul class="list-group list-group-flush text-start mt-3">
				<li class="list-group-item"><strong>Starts:</strong> {{ data.event.date_start }}</li>
				<li class="list-group-item"><strong>Ends:</strong> {{ data.event.date_end }}</li>
				<li class="list-group-item"><strong>Location:</strong> 
					{% if data.event.online %}
						Online ({{ data.event.location }})
					{% else %}
						{{ data.event.location }}
					{% endif %}
				</li>
				<li class="list-group-item"><strong>Organizer:</strong> {{ data.event.organizer.username }}</li>
				<li class="list-group-item"><strong>Players:</strong> {{ data.event.players.count }} / {{ data.event.max_players }}</li>

				{% if data.request_status %}
				<li class="list-group-item"><strong>Your request status:</strong>
					{% if data.request_status == "pending" %}
						<span class="badge bg-warning">Pending</span>
					{% elif data.request_status == "approved" %}
						<span class="badge bg-success">Approved</span>
					{% elif data.request_status == "rejected" %}
						<span class="badge bg-danger">Rejected</span>
					{% endif %}
				</li>
				{% endif %}

				{% if data.players %}
					<li class="list-group-item"><strong>Current players:</strong>
						<ul>
							{% for player in data.players %}
								<li>{{ player.username }}</li>
							{% endfor %}
						</ul>
					</li>
				{% endif %}
			</ul>

			<div class="mt-4">
				<h3>Time Remaining:</h3>
				<div id="countdown">
					{{ data.days|stringformat:"02d" }} :
					{{ data.hours|stringformat:"02d" }} :
					{{ data.minutes|stringformat:"02d" }} :
					{{ data.seconds|stringformat:"02d" }}
				</div>
				<small class="text-muted">Days : Hours : Minutes : Seconds</small>
			</div>

			{% if user.is_authenticated %}
				{% if data.event.organizer == user %}
					<p class="mt-3 text-muted">You are the organizer of this event.</p>
					<a href="{% url 'edit_event' data.event.id %}" class="btn btn-warning mt-2">Edit Event</a>
					<form method="post" action="{% url 'delete_event' data.event.id %}" style="display:inline;">
						{% csrf_token %}
						<button type="submit" class="btn btn-danger mt-2">Delete Event</button>
					</form>

					{% if data.pending_requests %}
						<div class="mt-4 text-start">
							<h4>Pending Requests:</h4>
							<ul class="list-group">
								{% for req in data.pending_requests %}
									<li class="d-flex justify-content-between align-items-center">
										{{ req.user.username }}
										<div>
											<a href="{% url 'manage_request' data.event.id req.id 'approve' %}" 
											   class="btn btn-success mt-2">Approve</a>
											<a href="{% url 'manage_request' data.event.id req.id 'reject' %}" 
											   class="btn btn-danger mt-2">Reject</a>
										</div>
									</li>
								{% endfor %}
							</ul>
						</div>
					{% endif %}
				{% else %}
					<form method="post" action="{% url 'join_event' data.event.id %}">
						{% csrf_token %}
						<button type="submit" class="btn btn-primary mt-3">Request to Join</button>
					</form>
				{% endif %}
			{% else %}
				<p class="mt-3"><a href="{% url 'login' %}">Login</a> to request joining this event.</p>
			{% endif %}

		</div>
	</div>

<script>
	function updateTimer() {
		const countdown = document.getElementById('countdown');
		let [days, hours, minutes, seconds] = countdown.textContent.split(':').map(x => parseInt(x.trim()));

		if (seconds > 0) {
			seconds--;
		} else {
			if (minutes > 0) {
				minutes--; seconds = 59;
			} else if (hours > 0) {
				hours--; minutes = 59; seconds = 59;
			} else if (days > 0) {
				days--; hours = 23; minutes = 59; seconds = 59;
			}
		}

		countdown.textContent =
			(days < 10 ? '0' : '') + days + ' : ' +
			(hours < 10 ? '0' : '') + hours + ' : ' +
			(minutes < 10 ? '0' : '') + minutes + ' : ' +
			(seconds < 10 ? '0' : '') + seconds;
	}

	setInterval(updateTimer, 1000);
</script>
{% endblock %}
